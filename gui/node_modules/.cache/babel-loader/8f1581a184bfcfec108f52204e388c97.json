{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.responseInterceptor = void 0;\n\nconst zlib = require(\"zlib\");\n/**\n * Intercept responses from upstream.\n * Automatically decompress (deflate, gzip, brotli).\n * Give developer the opportunity to modify intercepted Buffer and http.ServerResponse\n *\n * NOTE: must set options.selfHandleResponse=true (prevent automatic call of res.end())\n */\n\n\nfunction responseInterceptor(interceptor) {\n  return async function proxyRes(proxyRes, req, res) {\n    const originalProxyRes = proxyRes;\n    let buffer = Buffer.from('', 'utf8'); // decompress proxy response\n\n    const _proxyRes = decompress(proxyRes, proxyRes.headers['content-encoding']); // concat data stream\n\n\n    _proxyRes.on('data', chunk => buffer = Buffer.concat([buffer, chunk]));\n\n    _proxyRes.on('end', async () => {\n      // copy original headers\n      copyHeaders(proxyRes, res); // call interceptor with intercepted response (buffer)\n\n      const interceptedBuffer = Buffer.from(await interceptor(buffer, originalProxyRes, req, res)); // set correct content-length (with double byte character support)\n\n      res.setHeader('content-length', Buffer.byteLength(interceptedBuffer, 'utf8'));\n      res.write(interceptedBuffer);\n      res.end();\n    });\n\n    _proxyRes.on('error', error => {\n      res.end(`Error fetching proxied request: ${error.message}`);\n    });\n  };\n}\n\nexports.responseInterceptor = responseInterceptor;\n/**\n * Streaming decompression of proxy response\n * source: https://github.com/apache/superset/blob/9773aba522e957ed9423045ca153219638a85d2f/superset-frontend/webpack.proxy-config.js#L116\n */\n\nfunction decompress(proxyRes, contentEncoding) {\n  let _proxyRes = proxyRes;\n  let decompress;\n\n  switch (contentEncoding) {\n    case 'gzip':\n      decompress = zlib.createGunzip();\n      break;\n\n    case 'br':\n      decompress = zlib.createBrotliDecompress();\n      break;\n\n    case 'deflate':\n      decompress = zlib.createInflate();\n      break;\n\n    default:\n      break;\n  }\n\n  if (decompress) {\n    _proxyRes.pipe(decompress);\n\n    _proxyRes = decompress;\n  }\n\n  return _proxyRes;\n}\n/**\n * Copy original headers\n * https://github.com/apache/superset/blob/9773aba522e957ed9423045ca153219638a85d2f/superset-frontend/webpack.proxy-config.js#L78\n */\n\n\nfunction copyHeaders(originalResponse, response) {\n  response.statusCode = originalResponse.statusCode;\n  response.statusMessage = originalResponse.statusMessage;\n\n  if (response.setHeader) {\n    let keys = Object.keys(originalResponse.headers); // ignore chunked, brotli, gzip, deflate headers\n\n    keys = keys.filter(key => !['content-encoding', 'transfer-encoding'].includes(key));\n    keys.forEach(key => {\n      let value = originalResponse.headers[key];\n\n      if (key === 'set-cookie') {\n        // remove cookie domain\n        value = Array.isArray(value) ? value : [value];\n        value = value.map(x => x.replace(/Domain=[^;]+?/i, ''));\n      }\n\n      response.setHeader(key, value);\n    });\n  } else {\n    response.headers = originalResponse.headers;\n  }\n}","map":{"version":3,"sources":["C:/Users/nikro/Documents/GitHub/ampersand/gui/node_modules/http-proxy-middleware/dist/handlers/response-interceptor.js"],"names":["Object","defineProperty","exports","value","responseInterceptor","zlib","require","interceptor","proxyRes","req","res","originalProxyRes","buffer","Buffer","from","_proxyRes","decompress","headers","on","chunk","concat","copyHeaders","interceptedBuffer","setHeader","byteLength","write","end","error","message","contentEncoding","createGunzip","createBrotliDecompress","createInflate","pipe","originalResponse","response","statusCode","statusMessage","keys","filter","key","includes","forEach","Array","isArray","map","x","replace"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.responseInterceptor = void 0;\nconst zlib = require(\"zlib\");\n/**\n * Intercept responses from upstream.\n * Automatically decompress (deflate, gzip, brotli).\n * Give developer the opportunity to modify intercepted Buffer and http.ServerResponse\n *\n * NOTE: must set options.selfHandleResponse=true (prevent automatic call of res.end())\n */\nfunction responseInterceptor(interceptor) {\n    return async function proxyRes(proxyRes, req, res) {\n        const originalProxyRes = proxyRes;\n        let buffer = Buffer.from('', 'utf8');\n        // decompress proxy response\n        const _proxyRes = decompress(proxyRes, proxyRes.headers['content-encoding']);\n        // concat data stream\n        _proxyRes.on('data', (chunk) => (buffer = Buffer.concat([buffer, chunk])));\n        _proxyRes.on('end', async () => {\n            // copy original headers\n            copyHeaders(proxyRes, res);\n            // call interceptor with intercepted response (buffer)\n            const interceptedBuffer = Buffer.from(await interceptor(buffer, originalProxyRes, req, res));\n            // set correct content-length (with double byte character support)\n            res.setHeader('content-length', Buffer.byteLength(interceptedBuffer, 'utf8'));\n            res.write(interceptedBuffer);\n            res.end();\n        });\n        _proxyRes.on('error', (error) => {\n            res.end(`Error fetching proxied request: ${error.message}`);\n        });\n    };\n}\nexports.responseInterceptor = responseInterceptor;\n/**\n * Streaming decompression of proxy response\n * source: https://github.com/apache/superset/blob/9773aba522e957ed9423045ca153219638a85d2f/superset-frontend/webpack.proxy-config.js#L116\n */\nfunction decompress(proxyRes, contentEncoding) {\n    let _proxyRes = proxyRes;\n    let decompress;\n    switch (contentEncoding) {\n        case 'gzip':\n            decompress = zlib.createGunzip();\n            break;\n        case 'br':\n            decompress = zlib.createBrotliDecompress();\n            break;\n        case 'deflate':\n            decompress = zlib.createInflate();\n            break;\n        default:\n            break;\n    }\n    if (decompress) {\n        _proxyRes.pipe(decompress);\n        _proxyRes = decompress;\n    }\n    return _proxyRes;\n}\n/**\n * Copy original headers\n * https://github.com/apache/superset/blob/9773aba522e957ed9423045ca153219638a85d2f/superset-frontend/webpack.proxy-config.js#L78\n */\nfunction copyHeaders(originalResponse, response) {\n    response.statusCode = originalResponse.statusCode;\n    response.statusMessage = originalResponse.statusMessage;\n    if (response.setHeader) {\n        let keys = Object.keys(originalResponse.headers);\n        // ignore chunked, brotli, gzip, deflate headers\n        keys = keys.filter((key) => !['content-encoding', 'transfer-encoding'].includes(key));\n        keys.forEach((key) => {\n            let value = originalResponse.headers[key];\n            if (key === 'set-cookie') {\n                // remove cookie domain\n                value = Array.isArray(value) ? value : [value];\n                value = value.map((x) => x.replace(/Domain=[^;]+?/i, ''));\n            }\n            response.setHeader(key, value);\n        });\n    }\n    else {\n        response.headers = originalResponse.headers;\n    }\n}\n"]},"metadata":{},"sourceType":"script"}